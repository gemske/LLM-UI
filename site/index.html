<!DOCTYPE html>
<html lang="en" class="h-full dark">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>GemskeAI</title>

  <!-- Tailwind (only for small typographic helpers ‚Äì no build step) -->
  <script src="https://cdn.tailwindcss.com?plugins=typography"></script>

  <!-- ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ  CORE STYLES  ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
  <style>
     :root{
       --bg:#0d0d0d; --surface:#161616; --surface-alt:#1f1f1f;
       --primary:#10b981; --primary-hl:#34d399;
       --danger:#dc2626;  --danger-hl:#ef4444;
       --user-msg:#2563eb; --ai-msg:#374151; --think-bg:#4b5563;
       --btn-h:2.65rem;   --btn-radius:.5rem;
     }

     html,body{margin:0;height:100%;font-family:system-ui,sans-serif;background:var(--bg);color:#e5e7eb}
     header{background:var(--surface);padding:1rem;text-align:center;font-weight:700;color:var(--primary-hl);box-shadow:0 1px 0 #000}
     main{position:fixed;inset:64px 0 0 0;display:flex;flex-direction:column}

     .chat-area{flex:1;overflow-y:auto;padding:1rem;max-width:100%!important;margin:0!important}

     .content{white-space:normal;overflow-wrap:anywhere}
     .chat-area.preserve-format .content{white-space:pre-wrap;overflow-wrap:anywhere}

     .input-wrapper{border-top:1px solid #262626;background:var(--surface);display:flex;flex-direction:column}
     .input-controls{max-height:500px;overflow:hidden;transition:max-height .3s ease;display:flex;flex-direction:column;gap:.5rem}
     .input-controls.collapsed{max-height:0}
     .input-bar{display:flex;flex-direction:column;gap:0}

     .toggle-controls-btn,.toggle-think-btn{position:fixed;background:var(--surface-alt);border:none;padding:.5rem;border-radius:4px;cursor:pointer;z-index:1000;font-size:1.1rem;color:#e5e7eb}
     .toggle-controls-btn{top:.4rem;right:1rem}
     .toggle-think-btn{top:.4rem;left:.4rem;display:none}

     select,textarea,button{padding:.75rem;font-size:1rem;border:1px solid #303030;border-radius:5px;background:var(--surface-alt);color:#d1d5db}
     textarea{resize:vertical;min-height:50px}
     #userInput{flex:1;padding:1.2rem .5rem;line-height:1.4;background:var(--surface-alt);border:1px solid #2e2e2e;border-radius:var(--btn-radius);transition:border-color .18s}
     #userInput:focus{outline:none;border-color:var(--primary);box-shadow:0 0 0 2px color-mix(in srgb,var(--primary) 40%,transparent)}
     button{height:var(--btn-h);display:inline-flex;align-items:center;justify-content:center;font-weight:600;gap:.45rem;border-radius:var(--btn-radius);cursor:pointer;transition:background .18s,box-shadow .18s}

     #sendButton{background:var(--primary);color:#fff;height:100%}
     #sendButton:hover{background:var(--primary-hl)}
     #saveButton,#loadButton,#printButton{background:#2b2b2b;color:#d1d5db}
     #saveButton:hover,#loadButton:hover,#printButton:hover{background:#3b3b3b}
     #clearButton{background:var(--danger);color:#fff}
     #clearButton:hover{background:var(--danger-hl)}
     #toggleFormat,#advancedButton,#models{background:#242424;color:#d1d5db}
     #toggleFormat:hover,#advancedButton:hover,#models:hover{background:#353535}
     .input-controls div.button-row{display:flex;gap:0.5rem;flex-wrap:wrap}

     #loadContainer{display:none;gap:0.5rem;align-items:center}

     .message{margin-bottom:1rem;padding:.75rem 1rem;border-radius:12px;max-width:90%;clear:both}
     .user-message{background:var(--user-msg);color:#fff;float:right}
     .ai-message{background:var(--ai-msg);color:#fff;float:left}
     .sender{font-size:.75rem;opacity:.7;margin-bottom:.25rem}
     .think-content{background:var(--think-bg);padding:.5rem;margin-top:.5rem;border-radius:8px;color:#eee}
     .think-content.hidden{display:none}
     .typing-indicator{font-style:italic;opacity:.7}

     #toast{position:fixed;top:76px;left:50%;transform:translateX(-50%);background:rgba(0,0,0,.8);color:#fff;padding:.7rem 1.3rem;border-radius:6px;font-size:.9rem;opacity:0;pointer-events:none;transition:opacity .4s;z-index:1500}
     #toast.show{opacity:.9}

     @media(max-width:600px){.chat-area{padding:.5rem;font-size:.95rem;height:60vh} .input-wrapper{padding:.5rem} select,textarea,button{font-size:.9rem;padding:.6rem} .toggle-controls-btn{top:.6rem;right:.5rem}}
     @media(min-width:769px){.input-bar{flex-direction:row;align-items:flex-start} #sendButton{margin-left:.5rem}}
     #modelSelect,label[for="modelSelect"]{display:none}
   </style>
</head>
<body class="h-full">
  <button class="toggle-think-btn">üëÅÔ∏è</button>
  <button class="toggle-controls-btn">‚öôÔ∏è</button>
  <header>Gemske&nbsp;<span class="text-[color:var(--primary)]">AI</span></header>
  <main>
    <div id="chatBox" class="chat-area preserve-format prose prose-invert"></div>
    <div class="input-wrapper">
      <div id="controlsContainer" class="input-controls collapsed">
        <div class="button-row">
          <button id="saveButton">Save Chat</button>
          <button id="loadButton">Load Chat</button>
          <button id="clearButton">Clear Chat</button>
          <button id="printButton">Print</button>
          <button id="toggleFormat">Disable Formatting</button>
          <button id="advancedButton">Advanced</button>
          <button id="models">Models</button>
        </div>
        <div id="loadContainer">
          <select id="chatFiles"><option value="">Select a chat to load</option></select>
          <button id="loadConfirmButton">OK</button>
        </div>
        <label for="modelSelect">Select Model:</label>
        <select id="modelSelect"></select>
        <div id="currentModel" class="note"></div>
        <div id="error" class="error"></div>
      </div>
      <div class="input-bar">
        <textarea id="userInput" placeholder="Share your thoughts."></textarea>
        <button id="sendButton">Send</button>
      </div>
    </div>
  </main>
  <div id="toast"></div>
  <script>
  (()=>{
    const $=id=>document.getElementById(id);
    const chatBox=$('chatBox'), controls=$('controlsContainer'), modelSel=$('modelSelect'), currentModel=$('currentModel');
    const toggleBtn=document.querySelector('.toggle-controls-btn'), thinkBtn=document.querySelector('.toggle-think-btn');
    const formatBtn=$('toggleFormat'), loadBtn=$('loadButton'), loadContainer=$('loadContainer'), loadConfirm=$('loadConfirmButton');
    let chatHistory=[], showThink=false;
    function toast(msg){const t=$('toast'); t.textContent=msg; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'),3000);}
    let lS=false,rS=false;
    document.addEventListener('keydown',e=>{ if(e.code==='ShiftLeft') lS=true; if(e.code==='ShiftRight') rS=true; if(lS&&rS){thinkBtn.click(); lS=rS=false;} });
    document.addEventListener('keyup',e=>{ if(e.code==='ShiftLeft') lS=false; if(e.code==='ShiftRight') rS=false; });
    toggleBtn.onclick=()=>controls.classList.toggle('collapsed');
    thinkBtn.onclick=()=>{ showThink=!showThink; document.querySelectorAll('.think-content').forEach(el=>el.classList.toggle('hidden',!showThink)); };
    formatBtn.onclick=()=>{ chatBox.classList.toggle('preserve-format'); formatBtn.textContent=chatBox.classList.contains('preserve-format')?'Disable Formatting':'Enable Formatting'; };
    $('userInput').addEventListener('keydown',e=>{ if(e.key==='Enter'&&e.shiftKey){e.preventDefault(); sendMessage();} });

    onClick('sendButton', sendMessage);
    onClick('saveButton', saveChat);
    onClick('clearButton', clearChat);
    onClick('printButton', printChat);
    onClick('advancedButton', ()=>location.href='interface.html');
    onClick('models', ()=>location.href='use.html');

    loadBtn.onclick=()=>{
      controls.classList.remove('collapsed');
      loadContainer.style.display='flex';
      loadChatFiles();
    };
    loadConfirm.onclick=()=>{ loadChat(); loadContainer.style.display='none'; };

    function onClick(id, fn){ $(id).addEventListener('click', fn); }

    async function sendMessage(){
      const input=$('userInput'), text=input.value.trim(); if(!text) return;
      if(innerWidth<=600&&!controls.classList.contains('collapsed')) controls.classList.add('collapsed');
      chatHistory.push({role:'user',content:text}); appendMsg('You', text); input.value=''; $('error').textContent='';
      const typing=document.createElement('div'); typing.className='message ai-message'; typing.innerHTML='<div class="sender">AI</div><div class="typing-indicator">AI is typing‚Ä¶</div>';
      chatBox.appendChild(typing); chatBox.scrollTop=chatBox.scrollHeight;
      try{
        const res=await fetch('/api/chat',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({model:modelSel.value,messages:chatHistory})});
        const data=await res.json(); if(data.error){$('error').textContent=data.error;} else{ chatHistory.push({role:'assistant',content:data.message.content}); appendMsg('AI',data.message.content);}      }
      catch{ $('error').textContent='Network error'; }
    }

    function appendMsg(role,content){ const old=chatBox.querySelector('.typing-indicator'); if(old?.parentElement) old.parentElement.remove();
      const wrap=document.createElement('div'); wrap.className=`message ${role==='You'?'user-message':'ai-message'}`;
      const sender=document.createElement('div'); sender.className='sender'; sender.textContent=role; wrap.appendChild(sender);
      let html=content, hasThink=false;
      if(role==='AI'&& /<think>[\s\S]*?<\/think>/.test(content)){
        hasThink=true; const thinkTxt=content.match(/<think>([\s\S]*?)<\/think>/)[1]; html=content.replace(/<think>[\s\S]*?<\/think>/,'');
        const tdiv=document.createElement('div'); tdiv.className='think-content'+(showThink?'':' hidden'); tdiv.textContent=thinkTxt; wrap.appendChild(tdiv);
      }
      const msg=document.createElement('div'); msg.className='content'; msg.innerHTML=html; wrap.appendChild(msg);
      chatBox.appendChild(wrap); chatBox.scrollTop=chatBox.scrollHeight; if(hasThink) thinkBtn.style.display='block';
    }

    async function saveChat(){ const name=prompt('Filename (no extension):','chat-history'); if(!name) return; try{ const res=await fetch('/api/save-chat',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({messages:chatHistory,filename:name})}); const {filename,error}=await res.json(); error?alert('Error: '+error):(alert(`Saved as ${filename}`),loadChatFiles()); }catch{alert('Save failed');} }
    async function loadChat(){ const file=$('chatFiles').value; if(!file) return alert('Choose a chat first'); try{ const res=await fetch(`/api/load-chat/${file}`), {messages,error}=await res.json(); if(error) return alert(error);
        chatHistory=messages; chatBox.innerHTML=''; messages.forEach(m=>appendMsg(m.role==='user'?'You':'AI',m.content)); controls.classList.add('collapsed'); } catch{alert('Load failed');} }
    function printChat(){ const w=window.open('','','width=800,height=600'); w.document.write(`<html><head><title>Chat History</title><style>html,body{font-family:system-ui,sans-serif;background:#1e1e1e;color:#eee;padding:1rem}.message{margin-bottom:1rem;padding:.75rem 1rem;border-radius:12px;clear:both}.user-message{background:#2c2c2e;color:#fff}.ai-message{background:#3a3a3c;color:#fff}.sender{font-size:.75rem;opacity:.6;margin-bottom:.25rem}.think-content{background:#444;color:#ccc;padding:.5rem;margin-top:.5rem;border-radius:8px}.typing-indicator{font-style:italic;opacity:.7}</style></head><body>${chatBox.innerHTML}</body></html>`); w.document.close(); w.focus(); w.print(); }
    function clearChat(){ confirm('Clear?')&&(chatHistory=[],chatBox.innerHTML='',thinkBtn.style.display='none'); }
    async function loadChatFiles(){ const sel=$('chatFiles'); sel.innerHTML='<option value="">Select a chat to load</option>'; try{ const {files}=await (await fetch('/api/list-chats')).json(); files.forEach(f=>sel.add(new Option(f,f))); }catch{} }
    async function loadModels(){ try{ const {models}=await (await fetch('/api/models')).json(); modelSel.innerHTML=''; models.forEach(m=>modelSel.add(new Option(m.name,m.name))); const qs=new URLSearchParams(location.search).get('model'); modelSel.value=models.some(m=>m.name===qs)?qs:'mistral:latest'; currentModel.textContent=`Current model: ${modelSel.value}`; toast(`Model ‚Äú${modelSel.value}‚Äù loaded`);
        modelSel.addEventListener('change',()=>{currentModel.textContent=`Current model: ${modelSel.value}`; toast(`Model ‚Äú${modelSel.value}‚Äù loaded`);}); }catch{} }
    loadModels(); loadChatFiles();
  })();
  </script>
</body>
</html>
