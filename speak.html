<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Voice LLM Chat</title>
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
    rel="stylesheet"
  />
</head>
<body class="bg-light">
  <div class="container py-5">
    <h1 class="mb-4 text-center">üß† Voice Chat with LLM</h1>

    <div class="mb-3">
      <label for="modelSelect" class="form-label">Model</label>
      <select id="modelSelect" class="form-select">
        <option>Loading...</option>
      </select>
    </div>

    <div class="mb-3 text-center">
      <button id="recordBtn" class="btn btn-primary btn-lg px-5">üéôÔ∏è Start Recording</button>
    </div>

    <div class="text-center mb-3 text-muted" id="status">Idle</div>

    <audio id="responseAudio" class="w-100" controls hidden></audio>
  </div>

  <script>
    const recordBtn = document.getElementById("recordBtn");
    const status = document.getElementById("status");
    const modelSelect = document.getElementById("modelSelect");
    const audioEl = document.getElementById("responseAudio");

    let mediaRecorder;
    let audioChunks = [];

    // Load models from backend
    async function loadModels() {
      try {
        const res = await fetch("/api/models");
        const { models } = await res.json();
        modelSelect.innerHTML = "";
        models.forEach(({ name }) => {
          const opt = document.createElement("option");
          opt.value = name;
          opt.textContent = name;
          if (name.toLowerCase() === "charlie") opt.selected = true;
          modelSelect.appendChild(opt);
        });
      } catch (err) {
        modelSelect.innerHTML = `<option>Error loading models</option>`;
        console.error("Model fetch error:", err);
      }
    }

    loadModels();

    // Start/stop recording and send audio
    recordBtn.onclick = async () => {
      if (!mediaRecorder || mediaRecorder.state === "inactive") {
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        mediaRecorder = new MediaRecorder(stream);
        audioChunks = [];

        mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
        mediaRecorder.onstop = async () => {
          status.textContent = "Processing...";

          const audioBlob = new Blob(audioChunks, { type: "audio/wav" });
          const formData = new FormData();
          formData.append("audio", audioBlob, "recording.wav");
          formData.append("model", modelSelect.value);

          try {
            const response = await fetch("/upload", {
              method: "POST",
              body: formData,
            });

            if (!response.ok) {
              throw new Error("Server error");
            }

            const { audioUrl } = await response.json();
            audioEl.src = audioUrl;
            audioEl.hidden = false;
            audioEl.play();
            status.textContent = "‚úÖ Response received.";
          } catch (err) {
            console.error(err);
            status.textContent = "‚ùå Error processing audio.";
          }
        };

        mediaRecorder.start();
        recordBtn.textContent = "üõë Stop Recording";
        status.textContent = "üéôÔ∏è Recording...";
      } else {
        mediaRecorder.stop();
        recordBtn.textContent = "üéôÔ∏è Start Recording";
      }
    };
  </script>
</body>
</html>
